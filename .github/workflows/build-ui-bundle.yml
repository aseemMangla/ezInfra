jobs:
  list-branches:
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.get-branches.outputs.branches }}
    
    steps:
      - name: Get Repository Branches
        id: get-branches
        run: |
          echo "=== Fetching Available Branches ==="
          BRANCHES=$(curl -s -H "Authorization: token ${{ secrets.EZ_BOT }}" \
            "https://api.github.com/repos/aseemMangla/Scheduling-Oracle/branches" | \
            jq -r '.[].name' | tr '\n' ' ')
          
          echo "Available branches: $BRANCHES"
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          
          # Display branches for user reference
          echo "=== Available Branches in Repository ==="
          echo "$BRANCHES" | tr ' ' '\n' | sort
          echo "========================================"

  checkout-and-process:
    runs-on: ubuntu-latest
    needs: list-branches
    
    steps:
      - name: Display Available Branches
        run: |
          echo "=== Available Branches ==="
          echo "${{ needs.list-branches.outputs.branches }}" | tr ' ' '\n' | sort
          echo "========================="
          echo ""
          echo "Selected branches:"
          echo "UI Source Branch: ${{ github.event.inputs.UI_SRC_BRANCH }}"
          echo "App Source Branch: ${{ github.event.inputs.APP_SRC_BRANCH }}"
      
      - name: Validate Branch Existence
        run: |
          AVAILABLE_BRANCHES="${{ needs.list-branches.outputs.branches }}"
          UI_BRANCH="${{ github.event.inputs.UI_SRC_BRANCH }}"
          APP_BRANCH="${{ github.event.inputs.APP_SRC_BRANCH }}"
          
          echo "Validating branches..."
          
          if echo "$AVAILABLE_BRANCHES" | grep -q "\b$UI_BRANCH\b"; then
            echo "✅ UI Source Branch '$UI_BRANCH' exists"
          else
            echo "❌ UI Source Branch '$UI_BRANCH' does not exist"
            echo "Available branches: $(echo $AVAILABLE_BRANCHES | tr ' ' '\n' | sort | tr '\n' ' ')"
            exit 1
          fi
          
          if echo "$AVAILABLE_BRANCHES" | grep -q "\b$APP_BRANCH\b"; then
       name: UI Repository Workflow

on:
  workflow_dispatch:
    inputs:
      UI_SRC_BRANCH:
        description: 'UI Source Branch (check available branches in repo)'
        required: true
        default: 'master'
        type: string
      APP_SRC_BRANCH:
        description: 'App Source Branch (check available branches in repo)'
        required: true
        default: 'master'
        type: string
      APP_DEST_BRANCH:
        description: 'App Destination Branch'
        required: true
        default: 'feature/UIv2/${{ github.event.inputs.BUNDLE_NAME || "default" }}'
        type: string
      BUNDLE_NAME:
        description: 'Bundle Name (used in destination branch)'
        required: false
        type: string

env:
  UI_REPO_URL: 'https://github.com/aseemMangla/Scheduling-Oracle.git'

jobs:
  checkout-and-process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout UI Repository
        uses: actions/checkout@v4
        with:
          repository: 'aseemMangla/Scheduling-Oracle'
          ref: ${{ github.event.inputs.UI_SRC_BRANCH }}
          token: ${{ secrets.EZ_BOT }}
          path: 'ui-repo'
      
      - name: Display Workflow Parameters
        run: |
          echo "=== Workflow Parameters ==="
          echo "UI Source Branch: ${{ github.event.inputs.UI_SRC_BRANCH }}"
          echo "App Source Branch: ${{ github.event.inputs.APP_SRC_BRANCH }}"
          echo "App Destination Branch: ${{ github.event.inputs.APP_DEST_BRANCH }}"
          echo "Bundle Name: ${{ github.event.inputs.BUNDLE_NAME }}"
          echo "=========================="
      
      - name: List Repository Contents
        run: |
          echo "=== UI Repository Contents ==="
          ls -la ui-repo/
          echo "=============================="
      
      - name: Get Available Branches
        run: |
          cd ui-repo
          echo "=== Available Branches ==="
          git branch -r | grep -v HEAD | sed 's/origin\///' | sort
          echo "========================="
      
      # Add your additional workflow steps here
      # For example:
      # - name: Build UI
      #   run: |
      #     cd ui-repo
      #     npm install
      #     npm run build
      
      # - name: Deploy or Process
      #   run: |
      #     echo "Processing with branches:"
      #     echo "Source: ${{ github.event.inputs.UI_SRC_BRANCH }}"
      #     echo "App Source: ${{ github.event.inputs.APP_SRC_BRANCH }}"
      #     echo "Destination: ${{ github.event.inputs.APP_DEST_BRANCH }}"
